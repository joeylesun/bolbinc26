<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SUVOS 6 DASHBOARD</title>
    <style>
        /* === CLINICAL THEME === */
        :root {
            --bg: #ffffff; --panel: #f9fafb; --border: #e5e7eb;
            --c-wait: #eab308;   /* Yellow */
            --c-clean: #22c55e;  /* Green (Disinfection) */
            --c-stby: #9ca3af;   /* Gray (Standby) */
            --c-alert: #ef4444;  /* Red */
            --c-human: #1e3a8a;
            --c-wall: #2563eb;
            --c-edit: #2563eb;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; color: #111; }

        .sidebar { width: 340px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; box-shadow: 4px 0 15px rgba(0,0,0,0.02); z-index: 10; }
        h2 { margin: 0 0 20px 0; color: var(--c-wall); border-bottom: 2px solid var(--c-wall); padding-bottom: 10px; font-size: 1.4rem; font-weight: 800; }

        .metric-box { background: #fff; padding: 12px; border-radius: 6px; margin-bottom: 12px; border: 1px solid var(--border); }
        .metric-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.85rem; color: #666; font-weight: 600; }
        .metric-val { font-weight: 800; font-size: 1rem; color: #000; }

        .config-header { font-size: 0.75rem; font-weight: 700; color: #555; text-transform: uppercase; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 8px; }
        .config-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; }
        .config-label { font-size: 0.7rem; color: #666; margin-bottom: 2px; }
        .config-input { width: 100%; border: 1px solid #ccc; padding: 4px; border-radius: 4px; font-weight: 600; font-size: 0.9rem; box-sizing: border-box; }

        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; overflow-y: auto; max-height: 250px; }
        .zone-card { background: #fff; border: 1px solid var(--border); border-radius: 6px; padding: 8px; text-align: center; }
        .zone-card.occupied { background: #fef2f2; border-color: var(--c-alert); }
        .zone-timer { font-size: 1.2rem; font-weight: 800; margin: 4px 0; }
        .zone-state { font-size: 0.7rem; font-weight: 700; padding: 2px 6px; border-radius: 4px; color: #fff; text-transform: uppercase; display: inline-block; }

        .btn { width: 100%; padding: 8px; border: none; border-radius: 4px; font-weight: 700; cursor: pointer; margin-top: 5px; font-size: 0.8rem; }
        .btn-edit { background: var(--c-wall); color: #fff; }
        .btn-save { background: var(--c-clean); color: #fff; display: none; }
        .btn-reset { background: #ef4444; color: #fff; margin-top: 10px; font-size: 0.7rem; }

        .main-view { flex-grow: 1; position: relative; display: flex; justify-content: center; align-items: center; }
        canvas { background: transparent; }
        .legend { position: absolute; bottom: 20px; right: 20px; background: rgba(255,255,255,0.9); padding: 8px 16px; border-radius: 20px; display: flex; gap: 12px; border: 1px solid #ddd; font-size: 0.75rem; font-weight: 600; pointer-events: none; }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>SUVOS 6 DASHBOARD</h2>
    <div id="status" style="text-align:center; padding:8px; margin-bottom:15px; font-weight:700; font-size:0.75rem; border-radius:4px; background:#fee2e2; color:#991b1b;">CONNECTING...</div>

    <div class="metric-box">
        <div class="metric-row"><span>PEOPLE DETECTED</span><span class="metric-val" style="color:var(--c-human)" id="val-people">0</span></div>
        <div class="metric-row"><span>ACTIVE ZONES</span><span class="metric-val" style="color:var(--c-clean)" id="val-cleaning">0</span></div>
    </div>

    <div class="metric-box">
        <div class="config-header">Timers (Seconds)</div>
        <div class="config-grid">
            <div><div class="config-label">Wait</div><input type="number" id="cfg-wait" class="config-input" onchange="sendConfig()"></div>
            <div><div class="config-label">Disinfection</div><input type="number" id="cfg-clean" class="config-input" onchange="sendConfig()"></div>
            <div><div class="config-label">Standby</div><input type="number" id="cfg-stby" class="config-input" onchange="sendConfig()"></div>
        </div>
    </div>

    <div class="config-header" style="margin-top:10px;">SUVOS6 Status</div>
    <div class="dash-grid" id="zone-grid"></div>

    <div style="margin-top:auto; padding-top:10px; border-top:1px solid #eee;">
        <div class="config-header">Visual Adjustments</div>
        <div style="font-size:0.7rem; color:#666; margin-bottom:5px;">Drag points to fix jerky lines.</div>
        <button id="btn-edit" class="btn btn-edit" onclick="toggleEdit()">EDIT MAP LAYOUT</button>
        <button id="btn-save" class="btn btn-save" onclick="saveEdit()">SAVE MAP LOCALLY</button>
        <button onclick="clearSavedMap()" class="btn btn-reset">RESET TO RAW SCAN</button>
    </div>
</div>

<div class="main-view">
    <canvas id="canvas"></canvas>
    <div class="legend">
        <div><span class="dot" style="background:var(--c-human)"></span>Human</div>
        <div><span class="dot" style="background:var(--c-wait)"></span>Wait</div>
        <div><span class="dot" style="background:var(--c-clean)"></span>Disinfection</div>
        <div><span class="dot" style="background:var(--c-stby)"></span>Standby</div>
        <div><span class="dot" style="background:var(--c-alert)"></span>Collision</div>
    </div>
</div>

<script>
    const WS_URL = "ws://localhost:8765";
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // COLORS
    const COLORS = {
        wall: "#2563eb",   bg_fill: "#f8f9fa", grid: "#e5e7eb", edit: "#2563eb",
        human: "#1e3a8a",  wait: "#eab308",    clean: "#22c55e", stby: "#9ca3af", alert: "#ef4444"
    };

    let MAP_CFG = { scale: 1.0, off_x: 0, off_y: 0, map_size: 800, rotation: 0 };
    let ROOM_SHAPE = [], TEMP_SHAPE = [], STATIC_ZONES = [], livePeople = [], liveZoneData = {};
    let ws = null, isEditing = false, dragIdx = -1, hoverIdx = -1;

    canvas.width = 1000; canvas.height = 800;

    // === EDITING & PERSISTENCE ===
    function toggleEdit() {
        isEditing = true;
        TEMP_SHAPE = JSON.parse(JSON.stringify(ROOM_SHAPE));
        document.getElementById('btn-edit').style.display = 'none';
        document.getElementById('btn-save').style.display = 'block';
        drawFrame();
    }
    function saveEdit() {
        isEditing = false;
        ROOM_SHAPE = JSON.parse(JSON.stringify(TEMP_SHAPE));
        localStorage.setItem("suvos_room_shape", JSON.stringify(ROOM_SHAPE));
        document.getElementById('btn-edit').style.display = 'block';
        document.getElementById('btn-save').style.display = 'none';
        drawFrame();
    }
    function clearSavedMap() {
        if(confirm("Reset map to raw scan?")) { localStorage.removeItem("suvos_room_shape"); location.reload(); }
    }

    // Mouse Logic
    canvas.addEventListener('mousedown', () => { if(isEditing && hoverIdx !== -1) dragIdx = hoverIdx; });
    canvas.addEventListener('mouseup', () => { dragIdx = -1; });
    canvas.addEventListener('mousemove', e => {
        if(!isEditing) return;
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left, my = e.clientY - rect.top;
        if(dragIdx !== -1) {
            const sz = MAP_CFG.map_size;
            let rx = mx - (canvas.width - sz)/2, ry = my - (canvas.height - sz)/2;
            let mx_rot, my_rot;
            if (MAP_CFG.rotation === 0) { mx_rot=rx; my_rot=ry; }
            else if (MAP_CFG.rotation === 1) { mx_rot = sz-1-ry; my_rot = rx; }
            else if (MAP_CFG.rotation === 2) { mx_rot = sz-1-rx; my_rot = sz-1-ry; }
            else { mx_rot = ry; my_rot = sz-1-rx; }
            TEMP_SHAPE[dragIdx].x = mx_rot / MAP_CFG.scale + MAP_CFG.off_x;
            TEMP_SHAPE[dragIdx].y = (sz - my_rot) / MAP_CFG.scale + MAP_CFG.off_y;
            drawFrame();
        } else {
            hoverIdx = -1; let minDist = 15;
            TEMP_SHAPE.forEach((p, i) => {
                let sc = toScreen(p.x, p.y);
                if(Math.hypot(sc.x - mx, sc.y - my) < minDist) { minDist = Math.hypot(sc.x - mx, sc.y - my); hoverIdx = i; }
            });
            canvas.style.cursor = hoverIdx !== -1 ? 'pointer' : 'default';
            drawFrame();
        }
    });
    canvas.addEventListener('dblclick', () => {
        if(isEditing && hoverIdx !== -1) { TEMP_SHAPE.splice(hoverIdx, 1); hoverIdx = -1; drawFrame(); }
    });

    // === NETWORKING ===
    function connect() {
        ws = new WebSocket(WS_URL);
        const st = document.getElementById('status');
        ws.onopen = () => { st.innerText="SYSTEM ONLINE"; st.style.background="#dcfce7"; st.style.color="#166534"; };
        ws.onclose = () => { st.innerText="RETRYING..."; st.style.background="#fee2e2"; st.style.color="#991b1b"; setTimeout(connect, 2000); };
        ws.onmessage = (e) => { try { handlePacket(JSON.parse(e.data)); } catch(err){} };
    }

    function handlePacket(data) {
        if (data.type === "init") {
            MAP_CFG = data.config || MAP_CFG;
            STATIC_ZONES = data.zones || [];
            const saved = localStorage.getItem("suvos_room_shape");
            if (saved) ROOM_SHAPE = JSON.parse(saved);
            else {
                let raw = data.room_shape || [];
                if(raw.length > 50) ROOM_SHAPE = autoArchitect(raw);
                else ROOM_SHAPE = raw;
            }
            if(data.fsm_config) updateConfigUI(data.fsm_config);
            initDashboard();
            drawFrame();
        }
        else if (data.type === "update") {
            livePeople = data.people || [];
            if(data.led_states) data.led_states.forEach(z => liveZoneData[z.id] = z);
            updateDashboard();
            if(!isEditing) requestAnimationFrame(drawFrame);
        }
        else if (data.type === "CONFIG_UPDATE") updateConfigUI(data.fsm_config);
    }

    function autoArchitect(pts) {
        if(pts.length<3) return pts;
        let sim = [pts[0]];
        for(let i=1;i<pts.length;i++) {
            if(Math.hypot(pts[i].x-sim[sim.length-1].x, pts[i].y-sim[sim.length-1].y) > 0.8) sim.push(pts[i]);
        }
        return sim;
    }

    function initDashboard() {
        const g = document.getElementById('zone-grid'); g.innerHTML="";
        STATIC_ZONES.forEach(z => {
            let d = document.createElement('div'); d.className="zone-card"; d.id=`card-${z.id}`;
            d.innerHTML = `<div class="zone-id">SUVOS ${z.id}</div><div class="zone-timer" id="t-${z.id}">--</div><div class="zone-state" id="s-${z.id}">init</div>`;
            g.appendChild(d);
        });
    }

    // Helper to map backend codes to display names
    function getDisplayState(stateCode) {
        if(stateCode === "CLEAN") return "DISINFECTION";
        if(stateCode === "STBY") return "STANDBY";
        return stateCode; // WAIT
    }

    function updateDashboard() {
        document.getElementById('val-people').innerText = livePeople.length;
        document.getElementById('val-cleaning').innerText = Object.values(liveZoneData).filter(z=>z.state==='CLEAN').length;
        STATIC_ZONES.forEach(z => {
            let d = liveZoneData[z.id]; if(!d) return;
            document.getElementById(`t-${z.id}`).innerText = d.timer.toFixed(1)+"s";
            let sEl = document.getElementById(`s-${z.id}`), cEl = document.getElementById(`card-${z.id}`);

            if(d.occupied) {
                sEl.innerText="COLLISION"; sEl.style.background=COLORS.alert;
                cEl.className="zone-card occupied";
            } else {
                sEl.innerText = getDisplayState(d.state);
                sEl.style.background = d.state==="WAIT"?COLORS.wait:(d.state==="CLEAN"?COLORS.clean:COLORS.stby);
                cEl.className="zone-card";
            }
        });
    }

    function updateConfigUI(cfg) {
        document.getElementById('cfg-wait').value = cfg.waitingTime;
        document.getElementById('cfg-clean').value = cfg.disinfectionTime;
        document.getElementById('cfg-stby').value = cfg.standbyTime;
    }

    function sendConfig() {
        if(ws) ws.send(JSON.stringify({ type: "SET_CONFIG", fsm_config: {
            waitingTime: parseFloat(document.getElementById('cfg-wait').value),
            disinfectionTime: parseFloat(document.getElementById('cfg-clean').value),
            standbyTime: parseFloat(document.getElementById('cfg-stby').value)
        }}));
    }

    function toScreen(wx, wy) {
        let mx = (wx - MAP_CFG.off_x) * MAP_CFG.scale;
        let my = MAP_CFG.map_size - ((wy - MAP_CFG.off_y) * MAP_CFG.scale);
        let rx = mx, ry = my;
        const sz = MAP_CFG.map_size;
        if (MAP_CFG.rotation === 1) { rx = my; ry = sz - 1 - mx; }
        else if (MAP_CFG.rotation === 2) { rx = sz - 1 - mx; ry = sz - 1 - my; }
        else if (MAP_CFG.rotation === 3) { rx = sz - 1 - my; ry = mx; }
        return { x: rx + (canvas.width-sz)/2, y: ry + (canvas.height-sz)/2 };
    }

    function drawFrame() {
        ctx.fillStyle = "#ffffff"; ctx.fillRect(0,0,canvas.width, canvas.height);

        // 1. DRAW ROOM FILL
        const points = isEditing ? TEMP_SHAPE : ROOM_SHAPE;
        if(points.length > 0) {
            ctx.save(); ctx.beginPath();
            let start = toScreen(points[0].x, points[0].y);
            ctx.moveTo(start.x, start.y);
            points.slice(1).forEach(p => { let pt = toScreen(p.x, p.y); ctx.lineTo(pt.x, pt.y); });
            ctx.closePath();
            ctx.fillStyle = COLORS.bg_fill; ctx.fill();
            ctx.restore();
        }

        // 2. DRAW GRID (Top of fill)
        ctx.beginPath(); ctx.lineWidth = 1; ctx.strokeStyle = COLORS.grid;
        const step = MAP_CFG.scale * 1.0;
        const cx = canvas.width/2, cy = canvas.height/2;
        for(let x=cx%step; x<canvas.width; x+=step) { ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); }
        for(let y=cy%step; y<canvas.height; y+=step) { ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); }
        ctx.stroke();

        // 3. DRAW ROOM OUTLINE
        if(points.length > 0) {
            ctx.save(); ctx.beginPath();
            let start = toScreen(points[0].x, points[0].y);
            ctx.moveTo(start.x, start.y);
            points.slice(1).forEach(p => { let pt = toScreen(p.x, p.y); ctx.lineTo(pt.x, pt.y); });
            ctx.closePath();
            ctx.lineWidth = isEditing?2:3;
            ctx.strokeStyle = COLORS.wall; // Fixed Blue
            ctx.stroke();
            ctx.restore();
        }

        // 4. EDITOR DOTS
        if(isEditing) {
            points.forEach((p, i) => {
                let pt = toScreen(p.x, p.y);
                if (i > 0) {
                    let prev = toScreen(points[i-1].x, points[i-1].y);
                    ctx.beginPath(); ctx.moveTo(prev.x, prev.y); ctx.lineTo(pt.x, pt.y);
                    ctx.strokeStyle = COLORS.edit; ctx.lineWidth=1; ctx.stroke();
                }
                ctx.beginPath();
                let r = (i===hoverIdx || i===dragIdx) ? 8 : 5;
                ctx.arc(pt.x, pt.y, r, 0, Math.PI*2);
                ctx.fillStyle = COLORS.edit; ctx.fill();
                ctx.strokeStyle = "#fff"; ctx.lineWidth=2; ctx.stroke();
            });
        }

        // 5. ZONES
        if(!isEditing) {
            STATIC_ZONES.forEach(z => {
                let pt = toScreen(z.x, z.y);
                let d = liveZoneData[z.id] || {state:"STBY", occupied:false};
                let r = (z.radius || 3.0) * MAP_CFG.scale;

                ctx.beginPath(); ctx.arc(pt.x, pt.y, r, 0, Math.PI*2);
                if(d.occupied) { ctx.fillStyle="rgba(239,68,68,0.3)"; ctx.strokeStyle=COLORS.alert; }
                else if(d.state==="CLEAN") { ctx.fillStyle="rgba(34,197,94,0.3)"; ctx.strokeStyle=COLORS.clean; }
                else if(d.state==="WAIT") { ctx.fillStyle="rgba(234,179,8,0.3)"; ctx.strokeStyle=COLORS.wait; }
                else { ctx.fillStyle="rgba(156,163,175,0.2)"; ctx.strokeStyle=COLORS.stby; }
                ctx.fill(); ctx.stroke();

                // Center Dot
                ctx.beginPath(); ctx.arc(pt.x, pt.y, 4, 0, Math.PI*2);
                if(d.occupied) ctx.fillStyle=COLORS.alert;
                else if(d.state==="CLEAN") ctx.fillStyle=COLORS.clean;
                else if(d.state==="WAIT") ctx.fillStyle=COLORS.wait;
                else ctx.fillStyle=COLORS.stby;
                ctx.fill();

                // Label
                ctx.fillStyle="#111"; ctx.font="bold 12px Arial"; ctx.textAlign="center";
                ctx.fillText("S"+z.id, pt.x, pt.y-8);
            });
        }

        // 6. PEOPLE
        if(!isEditing) {
            livePeople.forEach(p => {
                let pt = toScreen(p.x, p.y);
                ctx.beginPath(); ctx.arc(pt.x, pt.y, 10, 0, Math.PI*2);
                ctx.fillStyle = COLORS.human; ctx.fill();
                ctx.lineWidth=2; ctx.strokeStyle="#fff"; ctx.stroke();
            });
        }
    }

    connect();
</script>
</body>
</html>